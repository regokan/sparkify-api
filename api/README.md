# Sparkify API

## Overview

The Sparkify API provides a GraphQL interface to access data from the `music_app_history` table stored in the `sparkify_keyspace` within Amazon Keyspaces (Cassandra). The API is built using FastAPI, Strawberry for the GraphQL schema, and is deployed as an AWS Lambda function, exposed via API Gateway.

## Key Components

- **FastAPI**: A lightweight web framework that powers the API.
- **Strawberry**: A GraphQL library used to define the schema and resolve queries.
- **Mangum**: An adapter that allows FastAPI to run on AWS Lambda behind API Gateway.
- **Cassandra Integration**: The API fetches data from the Cassandra `music_app_history` table, using credentials managed by AWS Secrets Manager.

## Files

- `Makefile`: Automates the packaging, deployment, and cleanup process for the Lambda function and its dependencies.
- `main.py`: The FastAPI app that defines the GraphQL API and sets up the Lambda handler for AWS deployment.
- `strawberry_schema.py`: Defines the GraphQL schema and query types to expose the `music_app_history` data.
- `requirements.txt`: Lists the Python dependencies needed for this Lambda function.

## How It Works

1. **GraphQL API**: The API exposes data through a `/graphql` endpoint where users can run queries to filter and sort data from the `music_app_history` table.
2. **AWS Lambda & API Gateway**: The FastAPI application is deployed to AWS Lambda, with API Gateway handling HTTP requests and routing them to the Lambda function.
3. **Cassandra Integration**: The API connects securely to Amazon Keyspaces (Cassandra) using credentials stored in AWS Secrets Manager.

## Deployment

### Steps:

1. **Create Cassandra Credentials**: The `create-cassandra-credentials` Makefile target fetches or creates service-specific credentials for the Lambda function to connect to Cassandra using IAM.
2. **Package the Code**: The `package` target in the Makefile packages the Lambda function code and SSL certificate into a zip file.

3. **Upload to S3**: The `upload` target uploads the Lambda function zip file to the specified S3 bucket.

4. **Package Lambda Layer**: The `layer_package` target installs the Cassandra driver and packages it into a Lambda Layer zip file.

5. **Deploy**: The `deploy` target packages, uploads, and cleans up the Lambda code and its layers, ensuring that everything is ready for execution.

## Example Makefile Commands

- **Package and Deploy**:

  ```bash
  make deploy
  ```

- **Create Cassandra Credentials**:

  ```bash
  make create-cassandra-credentials
  ```

- **Clean up**:
  ```bash
  make clean
  ```

## How to Run the API

1. **Deploy the API**: Use the `deploy` target in the Makefile to package and deploy the API to AWS Lambda.
2. **Access the GraphQL Endpoint**: Once deployed, the API will be available through an API Gateway endpoint (URL will be generated by API Gateway).

3. **Use GraphiQL Playground**: You can test the API using a GraphiQL interface to run queries like the ones listed above.
